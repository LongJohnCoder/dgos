
DEVSRCS := \
	device/vga.c \
	device/ahci.c \
	device/ide.c

DEVOBJS := $(DEVSRCS:.c=.o)

CSRCS := \
	bios_data.c \
	nano_time.c \
	cpu/cpu.c \
	cpu/apic.c \
	cpu/cmos.c \
	cpu/atomic.c \
	cpu/control_regs.c \
	cpu/cpuid.c \
	cpu/thread_impl.c \
	cpu/spinlock.c \
	cpu/halt.c \
	cpu/gdt.c \
	cpu/idt.c \
	cpu/interrupts.c \
	cpu/ioport.c \
	cpu/mmu.c \
	cpu/legacy_pic.c \
	cpu/legacy_pit.c \
	device/pci.c \
	device/keyb8042.c \
	device/e9debug.c \
	device/keyb8042_layout/keyb8042_layout_us.c \
	$(DEVSRCS)

ASRCS := entry.s \
	cpu/isr.s \
	generated_device_vtbl.s

LIBNAME := arch

CLEANOTHER += buildtool/keyb_tool

include $(BUILDROOT)/library.mk

# Generate a lookup table of devices
# To pull in constructors for devices
generated_device_vtbl.s: $(DEVOBJS)
	echo '# THIS FILE IS AUTOMATICALLY GENERATED' > $@ && \
		echo '# DO NOT BOTHER EDITING IT' >> $@ && \
		echo '# See arch/x86_64/Makefile' >> $@ && \
		echo '.globl device_constructor_list' >> $@ && \
		echo '.hidden device_constructor_list' >> $@ && \
		echo 'device_constructor_list:' >> $@ && \
		nm $^ | grep -oP '\S+_register_device' | \
			sed 's/.*/.quad &/' >> $@ && \
		echo '.quad 0' >> $@

buildtool/keyb_tool: device/keyb8042_layout/keyb8042_gentables.c
	mkdir -p buildtool
	$(CC) -Wall -Wextra -o $@ $^

all: buildtool/keyb_tool
