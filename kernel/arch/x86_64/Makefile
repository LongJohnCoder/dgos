
DEVSRCS := \
	device/vga.c \
	device/ahci.c

DEVOBJS := $(DEVSRCS:.c=.o)

CSRCS := \
	cpu/cpu.c \
	cpu/apic.c \
	cpu/atomic.c \
	cpu/control_regs.c \
	cpu/cpuid.c \
	cpu/gdt.c \
	cpu/halt.c \
	cpu/idt.c \
	cpu/interrupts.c \
	cpu/ioport.c \
	cpu/mmu.c \
	cpu/legacy_pic.c \
	cpu/legacy_pit.c \
	device/pci.c \
	device/legacy_keyboard.c \
	$(DEVSRCS)

ASRCS := entry.s \
	cpu/isr.s \
	generated_device_vtbl.s

LIBNAME := arch

include $(BUILDROOT)/library.mk

# Generate a lookup table of devices
# To pull in constructors for devices
generated_device_vtbl.s: $(DEVOBJS)
	echo '# THIS FILE IS AUTOMATICALLY GENERATED' > $@ && \
		echo '# DO NOT BOTHER EDITING IT' >> $@ && \
		echo '# See arch/x86_64/Makefile' >> $@ && \
		echo '.globl device_constructor_list' >> $@ && \
		echo 'device_constructor_list:' >> $@ && \
		nm $^ | grep -oP '\S+_register_device' | \
			sed 's/.*/.quad &/' >> $@ && \
		echo '.quad 0' >> $@
