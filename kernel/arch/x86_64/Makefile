
DEVSRCS := \
	device/vga.cc \
	device/ahci.cc \
	device/ide.cc \
	device/ata.cc \
	device/serial-uart.cc

DEVOBJS := $(DEVSRCS:.cc=.o)

CSRCS := \
	cpu/syscall_dispatch.cc \
	bios_data.cc \
	nano_time.cc \
	cpu/cpu.cc \
	cpu/apic.cc \
	cpu/cpu_broadcast.cc \
	cpu/cmos.cc \
	cpu/atomic.cc \
	cpu/control_regs.cc \
	cpu/cpuid.cc \
	cpu/thread_impl.cc \
	cpu/spinlock.cc \
	cpu/halt.cc \
	cpu/gdt.cc \
	cpu/idt.cc \
	cpu/interrupts.cc \
	cpu/ioport.cc \
	cpu/mmu.cc \
	cpu/nontemporal.cc \
	cpu/legacy_pic.cc \
	cpu/legacy_pit.cc \
	cpu/except.cc \
	cpu/math.cc \
	device/pci.cc \
	device/keyb8042.cc \
	device/e9debug.cc \
	device/rtl8139.cc \
	device/keyb8042_layout/keyb8042_layout_us.cc \
	device/usb_xhci.cc \
	bootdev.cc \
	elf64.cc \
	gdbstub.cc \
	$(DEVSRCS)

#OPTIMIZEDSRCS := cpu/thread_impl.cc
ifdef OPTIMIZEDSRCS
$(OPTIMIZEDSRCS:.cc=.o): CXXFLAGS += -O2
endif

cpu/math.o: CXXFLAGS += -fno-builtin-ilogbl

ASRCS := entry.s \
	cpu/syscall.s \
	cpu/isr.s \
	cpu/except_asm.s

#generated_device_vtbl.s

LIBNAME := arch

CLEANOTHER += buildtool/keyb_tool \
	generated_device_vtbl.o \
	generated_device_vtbl.s

include $(BUILDROOT)/library.mk

# Generate a lookup table of devices
# To pull in constructors for devices
#generated_device_vtbl.s: $(DEVOBJS)
#	echo Scanning device objects $^
#	echo '# THIS FILE IS AUTOMATICALLY GENERATED' > $@ && \
#		echo '# DO NOT BOTHER EDITING IT' >> $@ && \
#		echo '# See arch/x86_64/Makefile' >> $@ && \
#		echo '.global device_constructor_list' >> $@ && \
#		echo '.hidden device_constructor_list' >> $@ && \
#		echo 'device_constructor_list:' >> $@ && \
#		$(NM) $^ | grep -oP '\S+_' | \
#			sed 's/.*/.quad &/' >> $@ && \
#		echo '.quad 0' >> $@

buildtool/keyb_tool: device/keyb8042_layout/keyb8042_gentables.cc
	mkdir -p buildtool
	$(CXX) -Wall -Wextra -o $@ $^

all: buildtool/keyb_tool
