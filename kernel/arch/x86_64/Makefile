
DEVSRCS := \
	vga.c

DEVOBJS := $(DEVSRCS:.c=.o)

CSRCS := cpu.c \
	cpuid.c \
	msr.c \
	ioport.c \
	mmu.c \
	gdt.c \
	idt.c \
	apic.c \
	pci.c \
	legacy_keyboard.c \
	legacy_timer_pic.c \
	halt.c \
	$(DEVSRCS)

ASRCS := entry.s \
	generated_device_vtbl.s

LIBNAME := arch

include $(BUILDROOT)/library.mk

# Generate a lookup table of devices
# To pull in constructors for devices
generated_device_vtbl.s: $(DEVOBJS)
	echo '# THIS FILE IS AUTOMATICALLY GENERATED' > $@
	echo '# DO NOT BOTHER EDITING IT' >> $@
	echo '# See arch/x86_64/Makefile' >> $@
	echo '.globl device_constructor_list' >> $@
	echo 'device_constructor_list:' >> $@
	nm $^ | grep -oP '\S+_register_device' | \
		sed 's/.*/.quad &/' >> $@
	echo '.quad 0' >> $@
